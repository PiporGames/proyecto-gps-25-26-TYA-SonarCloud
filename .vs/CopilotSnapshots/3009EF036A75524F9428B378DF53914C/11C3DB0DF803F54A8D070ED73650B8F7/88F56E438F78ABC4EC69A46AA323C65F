Imports System
Imports System.Net
Imports System.IO
Imports System.Text
Imports System.Threading.Tasks
Imports System.Text.Json
Imports Npgsql

Module Program

    '==========================================================================
    ' Microservicio TEMAS y AUTORES proyecto OverSounds - GPS 2025-2026
    ' Creado por: Jos� Manuel de Torres Dominguez
    '==========================================================================
    ' PAR�METROS DE CONFIGURACI�N
    Dim host_ip As String = "localhost"
    Dim host_port As Integer = 8080
    Dim connectionString = "Host=pgnweb.ddns.net;Username=tya_admin;Password=12345;Database=tya"
    Dim db As NpgsqlDataSource = Nothing
    '==========================================================================

    Sub Main(args As String())
        ' Conectarse a la base de datos PostgreSQL
        Try
            db = NpgsqlDataSource.Create(connectionString)
            Console.WriteLine("Conexi�n a la base de datos PostgreSQL establecida correctamente.")
        Catch ex As Exception
            Console.WriteLine("Error al conectar a la base de datos PostgreSQL: " & ex.Message)
            Return
        End Try

        ' Iniciar el servidor de manera as�ncrona
        StartServerAsync(host_ip, host_port).GetAwaiter().GetResult()
    End Sub

    Async Function StartServerAsync(host_ip As String, host_port As Integer) As Task
        ' Crear el servidor HTTP
        Dim listener As New HttpListener()
        ' Configurar el prefijo (URL base) donde escuchar
        listener.Prefixes.Add("http://" + host_ip + ":" + host_port.ToString() + "/")

        Try
            ' Iniciar el servidor
            listener.Start()
            Console.WriteLine("Servidor HTTP iniciado en http://" + host_ip + ":" + host_port.ToString())
            Console.WriteLine("Presiona Ctrl+C para detener el servidor")
            Console.WriteLine()

            ' Bucle principal para manejar peticiones
            While True
                ' Esperar por una petici�n de manera as�ncrona
                Dim context As HttpListenerContext = Await listener.GetContextAsync()

                ' Manejar cada petici�n en una tarea separada (sin esperar a que termine)
                Dim fireAndForget = Task.Run(Async Function()
                                                 Await HandleRequestAsync(context.Request, context.Response)
                                             End Function)
            End While

        Catch ex As Exception
            Console.WriteLine($"Error: {ex.Message}")
        Finally
            ' Detener el servidor
            listener.Stop()
            Console.WriteLine("Servidor detenido")
        End Try
    End Function

    Async Function HandleRequestAsync(request As HttpListenerRequest, response As HttpListenerResponse) As Task
        Dim jsonResponse As String = GenerateErrorResponse("501", "No implementado")
        Dim contentType = "application/json"
        Dim statusCode As Integer = HttpStatusCode.OK
        Dim URLpath As String() = request.Url.AbsolutePath.Split("/"c) ' Ejemplo: /song/123

        Try
            ' Mostrar informaci�n de la petici�n
            Console.WriteLine($"[{DateTime.Now:HH:mm:ss}] Petici�n recibida: {request.HttpMethod} {request.Url.AbsolutePath}")

            ' Obtener segmentos de la URL de manera segura
            Dim resource As String = If(URLpath.Length > 1, URLpath(1), "")
            Dim action As String = If(URLpath.Length > 2, URLpath(2), "")

            ' Detectar la ruta personalizada
            If resource = "song" Then

                If action = "upload" AndAlso request.HttpMethod = "POST" Then
                    uploadSong(request, action, jsonResponse, statusCode)

                ElseIf action = "search" AndAlso request.HttpMethod = "GET" Then
                    searchSong(request, action, jsonResponse, statusCode)

                ElseIf IsNumeric(action) AndAlso request.HttpMethod = "GET" Then
                    getSong(request, action, jsonResponse, statusCode)

                ElseIf IsNumeric(action) AndAlso request.HttpMethod = "DELETE" Then
                    deleteSong(request, action, jsonResponse, statusCode)

                ElseIf IsNumeric(action) AndAlso request.HttpMethod = "PATCH" Then
                    updateSong(request, action, jsonResponse, statusCode)

                Else
                    ' Ruta no encontrada
                    jsonResponse = GenerateErrorResponse("404", "Recurso no encontrado")
                    statusCode = HttpStatusCode.NotFound
                End If


            ElseIf resource = "album" Then

                If action = "upload" AndAlso request.HttpMethod = "POST" Then
                    uploadAlbum(request, action, jsonResponse, statusCode)

                ElseIf action = "search" AndAlso request.HttpMethod = "GET" Then
                    searchAlbum(request, action, jsonResponse, statusCode)

                ElseIf IsNumeric(action) AndAlso request.HttpMethod = "GET" Then
                    getAlbum(request, action, jsonResponse, statusCode)

                ElseIf IsNumeric(action) AndAlso request.HttpMethod = "DELETE" Then
                    deleteAlbum(request, action, jsonResponse, statusCode)

                ElseIf IsNumeric(action) AndAlso request.HttpMethod = "PATCH" Then
                    updateAlbum(request, action, jsonResponse, statusCode)

                Else
                    ' Ruta no encontrada
                    jsonResponse = GenerateErrorResponse("404", "Recurso no encontrado")
                    statusCode = HttpStatusCode.NotFound
                End If


            ElseIf resource = "merch" Then

                If action = "upload" AndAlso request.HttpMethod = "POST" Then
                    uploadMerch(request, action, jsonResponse, statusCode)

                ElseIf action = "search" AndAlso request.HttpMethod = "GET" Then
                    searchMerch(request, action, jsonResponse, statusCode)

                ElseIf IsNumeric(action) AndAlso request.HttpMethod = "GET" Then
                    getMerch(request, action, jsonResponse, statusCode)

                ElseIf IsNumeric(action) AndAlso request.HttpMethod = "DELETE" Then
                    deleteMerch(request, action, jsonResponse, statusCode)

                ElseIf IsNumeric(action) AndAlso request.HttpMethod = "PATCH" Then
                    updateMerch(request, action, jsonResponse, statusCode)

                Else
                    ' Ruta no encontrada
                    jsonResponse = GenerateErrorResponse("404", "Recurso no encontrado")
                    statusCode = HttpStatusCode.NotFound
                End If


            ElseIf resource = "artist" Then

                If action = "upload" AndAlso request.HttpMethod = "POST" Then
                    uploadArtist(request, action, jsonResponse, statusCode)

                ElseIf action = "search" AndAlso request.HttpMethod = "GET" Then
                    searchArtist(request, action, jsonResponse, statusCode)

                ElseIf IsNumeric(action) AndAlso request.HttpMethod = "GET" Then
                    getArtist(request, action, jsonResponse, statusCode)

                ElseIf IsNumeric(action) AndAlso request.HttpMethod = "DELETE" Then
                    deleteArtist(request, action, jsonResponse, statusCode)

                ElseIf IsNumeric(action) AndAlso request.HttpMethod = "PATCH" Then
                    updateArtist(request, action, jsonResponse, statusCode)

                Else
                    ' Ruta no encontrada
                    jsonResponse = GenerateErrorResponse("404", "Recurso no encontrado")
                    statusCode = HttpStatusCode.NotFound
                End If


            ElseIf request.Url.AbsolutePath = "/" Then
                ' Ruta ra�z
                jsonResponse = ConvertToJson("Microservicio TEMAS y AUTORES proyecto OverSounds - GPS 2025-2026\nCreado por: Jos� Manuel de Torres Dominguez")
                statusCode = HttpStatusCode.OK


            Else
                ' Ruta no encontrada
                jsonResponse = GenerateErrorResponse("404", "Recurso no encontrado")
                statusCode = HttpStatusCode.NotFound
            End If


            ' Configurar la respuesta
            response.StatusCode = statusCode
            response.ContentType = contentType
            Dim buffer As Byte() = Encoding.UTF8.GetBytes(jsonResponse)
            response.ContentLength64 = buffer.Length

            ' Enviar la respuesta de manera as�ncrona
            Dim output As Stream = response.OutputStream
            Await output.WriteAsync(buffer, 0, buffer.Length)
            output.Close()

            Console.WriteLine($"[{DateTime.Now:HH:mm:ss}] Respuesta enviada: {statusCode} - {jsonResponse.Replace(Environment.NewLine, "")}")
            Console.WriteLine()

        Catch ex As Exception
            Console.WriteLine($"[{DateTime.Now:HH:mm:ss}] Error procesando petici�n: {ex.Message}")
            Console.WriteLine(ex.ToString)

            Try
                response.StatusCode = 500
                response.Close()
            Catch
                ' Ignorar errores al cerrar la respuesta
            End Try
        End Try
    End Function

    ' Funci�n helper para convertir lista de Strings a JSON
    Function ConvertToJson(obj As Object) As String
        Dim options As New JsonSerializerOptions With {.WriteIndented = True}
        Return JsonSerializer.Serialize(obj, options)
    End Function

    ' Funcion helper para generar una respuesta error JSON
    Function GenerateErrorResponse(code As String, message As String) As String
        Dim errorObj As New Dictionary(Of String, String) From {{"code", code}, {"message", message}}
        Return ConvertToJson(errorObj)
    End Function


    '==========================================================================
    ' L�GICA DE NEGOCIO
    '==========================================================================


    '==========================================================================
    ' M�TODOS PARA SONG
    '==========================================================================
    Sub uploadSong(request As HttpListenerRequest, action As String, ByRef jsonResponse As String, ByRef statusCode As Integer)
        Try
            ' Leer el body del request
            Dim body As String
            Using reader As New StreamReader(request.InputStream, request.ContentEncoding)
                body = reader.ReadToEnd()
            End Using

            ' Parsear el JSON
            Dim songData = JsonSerializer.Deserialize(Of Dictionary(Of String, JsonElement))(body)

            ' Validar campos requeridos
            If Not songData.ContainsKey("title") OrElse Not songData.ContainsKey("genres") OrElse 
               Not songData.ContainsKey("cover") OrElse Not songData.ContainsKey("price") OrElse
               Not songData.ContainsKey("albumId") OrElse Not songData.ContainsKey("albumOrder") Then
                jsonResponse = GenerateErrorResponse("400", "Faltan campos requeridos")
                statusCode = HttpStatusCode.BadRequest
                Return
            End If

            ' Obtener valores
            Dim title As String = songData("title").GetString()
            Dim description As String = If(songData.ContainsKey("description"), songData("description").GetString(), "")
            Dim cover As String = songData("cover").GetString()
            Dim price As Decimal = songData("price").GetDecimal()
            Dim albumId As Integer? = If(songData("albumId").ValueKind = JsonValueKind.Null, Nothing, CType(songData("albumId").GetInt32(), Integer?))
            Dim albumOrder As Integer? = If(songData.ContainsKey("albumOrder") AndAlso songData("albumOrder").ValueKind <> JsonValueKind.Null, CType(songData("albumOrder").GetInt32(), Integer?), Nothing)
            Dim releaseDate As String = If(songData.ContainsKey("releaseDate"), songData("releaseDate").GetString(), DateTime.Now.ToString("yyyy-MM-dd"))
            Dim trackId As Integer = 0 ' Por defecto, se debería generar/obtener
            Dim duration As Integer = 0 ' Por defecto, se debería calcular del track

            ' Insertar canción
            Dim newSongId As Integer
            Using cmd = db.CreateCommand("INSERT INTO canciones (titulo, descripcion, cover, albumog, track, duracion, fechalanzamiento, precio) VALUES (@titulo, @descripcion, @cover, @albumog, @track, @duracion, @fecha, @precio) RETURNING idcancion")
                cmd.Parameters.AddWithValue("@titulo", title)
                cmd.Parameters.AddWithValue("@descripcion", description)
                cmd.Parameters.AddWithValue("@cover", cover)
                cmd.Parameters.AddWithValue("@albumog", If(albumId, DBNull.Value))
                cmd.Parameters.AddWithValue("@track", trackId)
                cmd.Parameters.AddWithValue("@duracion", duration)
                cmd.Parameters.AddWithValue("@fecha", Date.Parse(releaseDate))
                cmd.Parameters.AddWithValue("@precio", price)
                newSongId = CInt(cmd.ExecuteScalar())
            End Using

            ' Insertar géneros
            If songData.ContainsKey("genres") Then
                For Each genreElement In songData("genres").EnumerateArray()
                    Dim genreId As Integer = genreElement.GetInt32()
                    Using cmd = db.CreateCommand("INSERT INTO generoscanciones (idcancion, idgenero) VALUES (@idcancion, @idgenero)")
                        cmd.Parameters.AddWithValue("@idcancion", newSongId)
                        cmd.Parameters.AddWithValue("@idgenero", genreId)
                        cmd.ExecuteNonQuery()
                    End Using
                Next
            End If

            ' Insertar colaboradores
            If songData.ContainsKey("collaborators") Then
                For Each collabElement In songData("collaborators").EnumerateArray()
                    Dim artistId As Integer = collabElement.GetInt32()
                    Using cmd = db.CreateCommand("INSERT INTO autorescanciones (idartista, idcancion, ft) VALUES (@idartista, @idcancion, @ft)")
                        cmd.Parameters.AddWithValue("@idartista", artistId)
                        cmd.Parameters.AddWithValue("@idcancion", newSongId)
                        cmd.Parameters.AddWithValue("@ft", True)
                        cmd.ExecuteNonQuery()
                    End Using
                Next
            End If

            ' Si tiene álbum, insertar en CancionesAlbumes
            If albumId.HasValue AndAlso albumOrder.HasValue Then
                Using cmd = db.CreateCommand("INSERT INTO cancionesalbumes (idcancion, idalbum, tracknumber) VALUES (@idcancion, @idalbum, @tracknumber)")
                    cmd.Parameters.AddWithValue("@idcancion", newSongId)
                    cmd.Parameters.AddWithValue("@idalbum", albumId.Value)
                    cmd.Parameters.AddWithValue("@tracknumber", albumOrder.Value)
                    cmd.ExecuteNonQuery()
                End Using
            End If

            jsonResponse = ConvertToJson(New Dictionary(Of String, Object) From {{"songId", newSongId}, {"message", "Canción creada exitosamente"}})
            statusCode = HttpStatusCode.OK

        Catch ex As Exception
            jsonResponse = GenerateErrorResponse("500", "Error al crear la canción: " & ex.Message)
            statusCode = HttpStatusCode.InternalServerError
        End Try
    End Sub

    Sub searchSong(request As HttpListenerRequest, action As String, ByRef jsonResponse As String, ByRef statusCode As Integer)
        Try
            ' Obtener parámetro de búsqueda
            Dim query As String = request.QueryString("q")
            If String.IsNullOrEmpty(query) Then
                jsonResponse = GenerateErrorResponse("400", "Parámetro de búsqueda 'q' requerido")
                statusCode = HttpStatusCode.BadRequest
                Return
            End If

            ' Buscar canciones por título (puede extenderse a otros campos)
            Dim results As New List(Of Dictionary(Of String, Object))

            Using cmd = db.CreateCommand("SELECT idcancion FROM canciones WHERE LOWER(titulo) LIKE LOWER(@query)")
                cmd.Parameters.AddWithValue("@query", "%" & query & "%")
                Using reader = cmd.ExecuteReader()
                    While reader.Read()
                        results.Add(New Dictionary(Of String, Object) From {{"songId", reader.GetInt32(0)}})
                    End While
                End Using
            End Using

            jsonResponse = ConvertToJson(results)
            statusCode = HttpStatusCode.OK

        Catch ex As Exception
            jsonResponse = GenerateErrorResponse("500", "Error al buscar canciones: " & ex.Message)
            statusCode = HttpStatusCode.InternalServerError
        End Try
    End Sub

    'TODO: No es capaz de procesar nulos
    Sub getSong(request As HttpListenerRequest, action As String, ByRef jsonResponse As String, ByRef statusCode As Integer)
        If Not IsNumeric(action) Then
            jsonResponse = GenerateErrorResponse("400", "ID de canci�n inv�lido")
            statusCode = HttpStatusCode.BadRequest
            Return
        End If

        ' Schema:
        Dim schema As New Dictionary(Of String, Object) From {
            {"songId", Nothing},
            {"title", Nothing},
            {"artistId", Nothing},
            {"collaborators", Nothing},
            {"releaseDate", Nothing},
            {"description", Nothing},
            {"duration", Nothing},
            {"genres", Nothing},
            {"cover", Nothing},
            {"price", Nothing},
            {"albumId", Nothing}
        }

        ' Recuperar todas las filas
        Using cmd = db.CreateCommand("SELECT titulo, descripcion, cover, albumog, duracion, fechalanzamiento, precio FROM canciones WHERE idcancion = @id")
            cmd.Parameters.AddWithValue("@id", Integer.Parse(action))
            Using reader = cmd.ExecuteReader()
                If reader.HasRows Then
                    While reader.Read()
                        schema("songId") = action
                        schema("title") = reader.GetString(0)
                        schema("description") = reader.GetString(1)
                        schema("cover") = reader.GetString(2)
                        schema("albumId") = reader.GetInt32(3).ToString()
                        schema("duration") = reader.GetInt32(4).ToString()
                        schema("releaseDate") = reader.GetString(5)
                        schema("price") = reader.GetFloat(6).ToString()
                    End While
                Else
                    jsonResponse = ""
                    statusCode = HttpStatusCode.NotFound
                    Return
                End If
            End Using
        End Using

        ' Recuperar autor y colaboradores
        Dim collaborators As New List(Of Integer)
        Using cmd = db.CreateCommand("SELECT idartista, ft FROM autorescanciones WHERE idcancion = @id")
            cmd.Parameters.AddWithValue("@id", Integer.Parse(action))
            Using reader = cmd.ExecuteReader()
                While reader.Read()
                    If reader.GetBoolean(1) = False Then
                        schema("artistId") = reader.GetInt32(0).ToString()
                    Else
                        collaborators.Add(reader.GetInt32(0))
                    End If
                End While
            End Using
        End Using
        schema("collaborators") = collaborators

        ' Recuperar g�neros
        Dim genres As New List(Of String)
        Using cmd = db.CreateCommand("SELECT idgenero FROM generoscanciones WHERE idcancion = @id")
            cmd.Parameters.AddWithValue("@id", Integer.Parse(action))
            Using reader = cmd.ExecuteReader()
                While reader.Read()
                    genres.Add(reader.GetInt32(0).ToString())
                End While
            End Using
        End Using
        schema("genres") = genres

        jsonResponse = ConvertToJson(schema)
        statusCode = HttpStatusCode.OK
    End Sub

    Sub deleteSong(request As HttpListenerRequest, action As String, ByRef jsonResponse As String, ByRef statusCode As Integer)
        Try
            If Not IsNumeric(action) Then
                jsonResponse = GenerateErrorResponse("400", "ID de canción inválido")
                statusCode = HttpStatusCode.BadRequest
                Return
            End If

            Dim songId As Integer = Integer.Parse(action)

            ' Eliminar canción (las relaciones se eliminan en cascada)
            Using cmd = db.CreateCommand("DELETE FROM canciones WHERE idcancion = @id")
                cmd.Parameters.AddWithValue("@id", songId)
                Dim rowsAffected As Integer = cmd.ExecuteNonQuery()
                
                If rowsAffected = 0 Then
                    jsonResponse = GenerateErrorResponse("404", "Canción no encontrada")
                    statusCode = HttpStatusCode.NotFound
                Else
                    jsonResponse = ConvertToJson(New Dictionary(Of String, String) From {{"message", "Canción eliminada exitosamente"}})
                    statusCode = HttpStatusCode.OK
                End If
            End Using

        Catch ex As Exception
            jsonResponse = GenerateErrorResponse("500", "Error al eliminar la canción: " & ex.Message)
            statusCode = HttpStatusCode.InternalServerError
        End Try
    End Sub

    Sub updateSong(request As HttpListenerRequest, action As String, ByRef jsonResponse As String, ByRef statusCode As Integer)
        Try
            If Not IsNumeric(action) Then
                jsonResponse = GenerateErrorResponse("400", "ID de canción inválido")
                statusCode = HttpStatusCode.BadRequest
                Return
            End If

            Dim songId As Integer = Integer.Parse(action)

            ' Leer el body del request
            Dim body As String
            Using reader As New StreamReader(request.InputStream, request.ContentEncoding)
                body = reader.ReadToEnd()
            End Using

            Dim songData = JsonSerializer.Deserialize(Of Dictionary(Of String, JsonElement))(body)

            ' Construir UPDATE dinámico solo con los campos presentes
            Dim updates As New List(Of String)
            Dim cmdText As String = "UPDATE canciones SET "

            Using cmd = db.CreateCommand("")
                If songData.ContainsKey("title") Then
                    updates.Add("titulo = @titulo")
                    cmd.Parameters.AddWithValue("@titulo", songData("title").GetString())
                End If
                If songData.ContainsKey("description") Then
                    updates.Add("descripcion = @descripcion")
                    cmd.Parameters.AddWithValue("@descripcion", songData("description").GetString())
                End If
                If songData.ContainsKey("cover") Then
                    updates.Add("cover = @cover")
                    cmd.Parameters.AddWithValue("@cover", songData("cover").GetString())
                End If
                If songData.ContainsKey("price") Then
                    updates.Add("precio = @precio")
                    cmd.Parameters.AddWithValue("@precio", songData("price").GetDecimal())
                End If
                If songData.ContainsKey("releaseDate") Then
                    updates.Add("fechalanzamiento = @fecha")
                    cmd.Parameters.AddWithValue("@fecha", Date.Parse(songData("releaseDate").GetString()))
                End If
                If songData.ContainsKey("albumId") Then
                    updates.Add("albumog = @albumog")
                    cmd.Parameters.AddWithValue("@albumog", If(songData("albumId").ValueKind = JsonValueKind.Null, DBNull.Value, CType(songData("albumId").GetInt32(), Object)))
                End If

                If updates.Count > 0 Then
                    cmd.CommandText = cmdText & String.Join(", ", updates) & " WHERE idcancion = @id"
                    cmd.Parameters.AddWithValue("@id", songId)
                    cmd.ExecuteNonQuery()
                End If
            End Using

            ' Actualizar géneros si están presentes
            If songData.ContainsKey("genres") Then
                Using cmd = db.CreateCommand("DELETE FROM generoscanciones WHERE idcancion = @id")
                    cmd.Parameters.AddWithValue("@id", songId)
                    cmd.ExecuteNonQuery()
                End Using

                For Each genreElement In songData("genres").EnumerateArray()
                    Using cmd = db.CreateCommand("INSERT INTO generoscanciones (idcancion, idgenero) VALUES (@idcancion, @idgenero)")
                        cmd.Parameters.AddWithValue("@idcancion", songId)
                        cmd.Parameters.AddWithValue("@idgenero", genreElement.GetInt32())
                        cmd.ExecuteNonQuery()
                    End Using
                Next
            End If

            ' Actualizar colaboradores si están presentes
            If songData.ContainsKey("collaborators") Then
                Using cmd = db.CreateCommand("DELETE FROM autorescanciones WHERE idcancion = @id AND ft = true")
                    cmd.Parameters.AddWithValue("@id", songId)
                    cmd.ExecuteNonQuery()
                End Using

                For Each collabElement In songData("collaborators").EnumerateArray()
                    Using cmd = db.CreateCommand("INSERT INTO autorescanciones (idartista, idcancion, ft) VALUES (@idartista, @idcancion, @ft)")
                        cmd.Parameters.AddWithValue("@idartista", collabElement.GetInt32())
                        cmd.Parameters.AddWithValue("@idcancion", songId)
                        cmd.Parameters.AddWithValue("@ft", True)
                        cmd.ExecuteNonQuery()
                    End Using
                Next
            End If

            ' Actualizar orden en álbum si está presente
            If songData.ContainsKey("albumOrder") AndAlso songData("albumOrder").ValueKind <> JsonValueKind.Null Then
                Using cmd = db.CreateCommand("UPDATE cancionesalbumes SET tracknumber = @tracknumber WHERE idcancion = @id")
                    cmd.Parameters.AddWithValue("@tracknumber", songData("albumOrder").GetInt32())
                    cmd.Parameters.AddWithValue("@id", songId)
                    cmd.ExecuteNonQuery()
                End Using
            End If

            jsonResponse = ConvertToJson(New Dictionary(Of String, String) From {{"message", "Canción actualizada exitosamente"}})
            statusCode = HttpStatusCode.OK

        Catch ex As Exception
            jsonResponse = GenerateErrorResponse("500", "Error al actualizar la canción: " & ex.Message)
            statusCode = HttpStatusCode.InternalServerError
        End Try
    End Sub

    '==========================================================================
    ' M�TODOS PARA ALBUM
    '==========================================================================
    Sub uploadAlbum(request As HttpListenerRequest, action As String, ByRef jsonResponse As String, ByRef statusCode As Integer)
        Try
            Dim body As String
            Using reader As New StreamReader(request.InputStream, request.ContentEncoding)
                body = reader.ReadToEnd()
            End Using

            Dim albumData = JsonSerializer.Deserialize(Of Dictionary(Of String, JsonElement))(body)

            ' Validar campos requeridos (removido "genres" de la validación)
            If Not albumData.ContainsKey("title") OrElse Not albumData.ContainsKey("songs") OrElse
   Not albumData.ContainsKey("cover") OrElse Not albumData.ContainsKey("price") Then
                jsonResponse = GenerateErrorResponse("400", "Faltan campos requeridos")
                statusCode = HttpStatusCode.BadRequest
                Return
            End If

            Dim title As String = albumData("title").GetString()
            Dim cover As String = albumData("cover").GetString()
            Dim price As Decimal = albumData("price").GetDecimal()
            Dim releaseDate As String = If(albumData.ContainsKey("releaseDate"), albumData("releaseDate").GetString(), DateTime.Now.ToString("yyyy-MM-dd"))
            Dim description As String = If(albumData.ContainsKey("description"), albumData("description").GetString(), "")

            ' Insertar álbum
            Dim newAlbumId As Integer
            Using cmd = db.CreateCommand("INSERT INTO albumes (titulo, cover, fechalanzamiento, precio, precioauto) VALUES (@titulo, @cover, @fecha, @precio, @precioauto) RETURNING idalbum")
                cmd.Parameters.AddWithValue("@titulo", title)
            cmd.Parameters.AddWithValue("@cover", cover)
        cmd.Parameters.AddWithValue("@fecha", Date.Parse(releaseDate))
    cmd.Parameters.AddWithValue("@precio", price)
        cmd.Parameters.AddWithValue("@precioauto", False)
                newAlbumId = CInt(cmd.ExecuteScalar())
     End Using

            ' Los géneros del álbum ahora se derivan automáticamente de las canciones (no se insertan directamente)

         ' Insertar colaboradores
        If albumData.ContainsKey("collaborators") Then
  For Each collabElement In albumData("collaborators").EnumerateArray()
         Dim artistId As Integer = collabElement.GetInt32()
 Using cmd = db.CreateCommand("INSERT INTO autoresalbumes (idartista, idalbum, ft) VALUES (@idartista, @idalbum, @ft)")
                cmd.Parameters.AddWithValue("@idartista", artistId)
    cmd.Parameters.AddWithValue("@idalbum", newAlbumId)
          cmd.Parameters.AddWithValue("@ft", True)
              cmd.ExecuteNonQuery()
        End Using
Next
 End If

    ' Vincular canciones al álbum
          If albumData.ContainsKey("songs") Then
         Dim trackNumber As Integer = 1
          For Each songElement In albumData("songs").EnumerateArray()
         Dim songId As Integer = songElement.GetInt32()
     Using cmd = db.CreateCommand("INSERT INTO cancionesalbumes (idcancion, idalbum, tracknumber) VALUES (@idcancion, @idalbum, @tracknumber) ON CONFLICT (idcancion, idalbum) DO UPDATE SET tracknumber = @tracknumber")
  cmd.Parameters.AddWithValue("@idcancion", songId)
        cmd.Parameters.AddWithValue("@idalbum", newAlbumId)
              cmd.Parameters.AddWithValue("@tracknumber", trackNumber)
                cmd.ExecuteNonQuery()
    End Using
          ' También actualizar albumog en canciones
     Using cmd = db.CreateCommand("UPDATE canciones SET albumog = @albumid WHERE idcancion = @idcancion")
       cmd.Parameters.AddWithValue("@albumid", newAlbumId)
        cmd.Parameters.AddWithValue("@idcancion", songId)
            cmd.ExecuteNonQuery()
 End Using
       trackNumber += 1
       Next
End If

  jsonResponse = ConvertToJson(New Dictionary(Of String, Object) From {{"albumId", newAlbumId}, {"message", "Álbum creado exitosamente"}})
statusCode = HttpStatusCode.OK

        Catch ex As Exception
            jsonResponse = GenerateErrorResponse("500", "Error al crear el álbum: " & ex.Message)
     statusCode = HttpStatusCode.InternalServerError
        End Try
    End Sub

    Sub searchAlbum(request As HttpListenerRequest, action As String, ByRef jsonResponse As String, ByRef statusCode As Integer)
        Try
            Dim query As String = request.QueryString("q")
            If String.IsNullOrEmpty(query) Then
                jsonResponse = GenerateErrorResponse("400", "Parámetro de búsqueda 'q' requerido")
                statusCode = HttpStatusCode.BadRequest
                Return
            End If

            Dim results As New List(Of Dictionary(Of String, Object))

            Using cmd = db.CreateCommand("SELECT idalbum FROM albumes WHERE LOWER(titulo) LIKE LOWER(@query)")
                cmd.Parameters.AddWithValue("@query", "%" & query & "%")
                Using reader = cmd.ExecuteReader()
                    While reader.Read()
                        results.Add(New Dictionary(Of String, Object) From {{"albumId", reader.GetInt32(0)}})
                    End While
                End Using
            End Using

            jsonResponse = ConvertToJson(results)
            statusCode = HttpStatusCode.OK

        Catch ex As Exception
            jsonResponse = GenerateErrorResponse("500", "Error al buscar álbumes: " & ex.Message)
            statusCode = HttpStatusCode.InternalServerError
        End Try
    End Sub

    Sub getAlbum(request As HttpListenerRequest, action As String, ByRef jsonResponse As String, ByRef statusCode As Integer)
        Try
            If Not IsNumeric(action) Then
                jsonResponse = GenerateErrorResponse("400", "ID de álbum inválido")
                statusCode = HttpStatusCode.BadRequest
                Return
            End If

            Dim schema As New Dictionary(Of String, Object) From {
                {"albumId", Nothing},
                {"title", Nothing},
                {"artistId", Nothing},
                {"collaborators", Nothing},
                {"description", Nothing},
                {"releaseDate", Nothing},
                {"genres", Nothing},
                {"songs", Nothing},
                {"cover", Nothing},
                {"price", Nothing}
            }

            ' Recuperar datos del álbum
            Using cmd = db.CreateCommand("SELECT titulo, cover, fechalanzamiento, precio FROM albumes WHERE idalbum = @id")
                cmd.Parameters.AddWithValue("@id", Integer.Parse(action))
                Using reader = cmd.ExecuteReader()
                    If reader.HasRows Then
                        While reader.Read()
                            schema("albumId") = action
                            schema("title") = reader.GetString(0)
                            schema("cover") = reader.GetString(1)
                            schema("releaseDate") = reader.GetDateTime(2).ToString("yyyy-MM-dd")
                            schema("price") = reader.GetDecimal(3).ToString()
                        End While
                    Else
                        jsonResponse = ""
                        statusCode = HttpStatusCode.NotFound
                        Return
                    End If
                End Using
            End Using

            ' Recuperar autor y colaboradores
            Dim collaborators As New List(Of Integer)
            Using cmd = db.CreateCommand("SELECT idartista, ft FROM autoresalbumes WHERE idalbum = @id")
                cmd.Parameters.AddWithValue("@id", Integer.Parse(action))
                Using reader = cmd.ExecuteReader()
                    While reader.Read()
                        If reader.GetBoolean(1) = False Then
                            schema("artistId") = reader.GetInt32(0).ToString()
                        Else
                            collaborators.Add(reader.GetInt32(0))
                        End If
                    End While
                End Using
            End Using
            schema("collaborators") = collaborators

            ' Recuperar canciones del álbum
            Dim songs As New List(Of Integer)
            Using cmd = db.CreateCommand("SELECT idcancion FROM cancionesalbumes WHERE idalbum = @id ORDER BY tracknumber")
                cmd.Parameters.AddWithValue("@id", Integer.Parse(action))
                Using reader = cmd.ExecuteReader()
                    While reader.Read()
                        songs.Add(reader.GetInt32(0))
                    End While
                End Using
            End Using
            schema("songs") = songs

            ' Recuperar géneros (de las canciones del álbum como aproximación)
            Dim genres As New List(Of Integer)
            Using cmd = db.CreateCommand("SELECT DISTINCT gc.idgenero FROM generoscanciones gc INNER JOIN cancionesalbumes ca ON gc.idcancion = ca.idcancion WHERE ca.idalbum = @id")
                cmd.Parameters.AddWithValue("@id", Integer.Parse(action))
                Using reader = cmd.ExecuteReader()
                    While reader.Read()
                        genres.Add(reader.GetInt32(0))
                    End While
                End Using
            End Using
            schema("genres") = genres

            schema("description") = "" ' No hay campo descripción en la tabla albumes

            jsonResponse = ConvertToJson(schema)
            statusCode = HttpStatusCode.OK

        Catch ex As Exception
            jsonResponse = GenerateErrorResponse("500", "Error al obtener el álbum: " & ex.Message)
            statusCode = HttpStatusCode.InternalServerError
        End Try
    End Sub

    Sub deleteAlbum(request As HttpListenerRequest, action As String, ByRef jsonResponse As String, ByRef statusCode As Integer)
        Try
            If Not IsNumeric(action) Then
                jsonResponse = GenerateErrorResponse("400", "ID de álbum inválido")
                statusCode = HttpStatusCode.BadRequest
                Return
            End If

            Dim albumId As Integer = Integer.Parse(action)

            ' Eliminar álbum (las relaciones se eliminan en cascada)
            Using cmd = db.CreateCommand("DELETE FROM albumes WHERE idalbum = @id")
                cmd.Parameters.AddWithValue("@id", albumId)
                Dim rowsAffected As Integer = cmd.ExecuteNonQuery()
                
                If rowsAffected = 0 Then
                    jsonResponse = GenerateErrorResponse("404", "Álbum no encontrado")
                    statusCode = HttpStatusCode.NotFound
                Else
                    jsonResponse = ConvertToJson(New Dictionary(Of String, String) From {{"message", "Álbum eliminado exitosamente"}})
                    statusCode = HttpStatusCode.OK
                End If
            End Using

        Catch ex As Exception
            jsonResponse = GenerateErrorResponse("500", "Error al eliminar el álbum: " & ex.Message)
            statusCode = HttpStatusCode.InternalServerError
        End Try
    End Sub

    Sub updateAlbum(request As HttpListenerRequest, action As String, ByRef jsonResponse As String, ByRef statusCode As Integer)
        Try
            If Not IsNumeric(action) Then
                jsonResponse = GenerateErrorResponse("400", "ID de álbum inválido")
                statusCode = HttpStatusCode.BadRequest
                Return
            End If

            Dim albumId As Integer = Integer.Parse(action)

            Dim body As String
            Using reader As New StreamReader(request.InputStream, request.ContentEncoding)
                body = reader.ReadToEnd()
            End Using

            Dim albumData = JsonSerializer.Deserialize(Of Dictionary(Of String, JsonElement))(body)

            ' Construir UPDATE dinámico
            Dim updates As New List(Of String)
            Dim cmdText As String = "UPDATE albumes SET "

            Using cmd = db.CreateCommand("")
                If albumData.ContainsKey("title") Then
                    updates.Add("titulo = @titulo")
                    cmd.Parameters.AddWithValue("@titulo", albumData("title").GetString())
                End If
                If albumData.ContainsKey("cover") Then
                    updates.Add("cover = @cover")
                    cmd.Parameters.AddWithValue("@cover", albumData("cover").GetString())
                End If
                If albumData.ContainsKey("price") Then
                    updates.Add("precio = @precio")
                    cmd.Parameters.AddWithValue("@precio", albumData("price").GetDecimal())
                End If
                If albumData.ContainsKey("releaseDate") Then
                    updates.Add("fechalanzamiento = @fecha")
                    cmd.Parameters.AddWithValue("@fecha", Date.Parse(albumData("releaseDate").GetString()))
                End If

                If updates.Count > 0 Then
                    cmd.CommandText = cmdText & String.Join(", ", updates) & " WHERE idalbum = @id"
                    cmd.Parameters.AddWithValue("@id", albumId)
                    cmd.ExecuteNonQuery()
                End If
            End Using

            ' Actualizar colaboradores si están presentes
            If albumData.ContainsKey("collaborators") Then
                Using cmd = db.CreateCommand("DELETE FROM autoresalbumes WHERE idalbum = @id AND ft = true")
                    cmd.Parameters.AddWithValue("@id", albumId)
                    cmd.ExecuteNonQuery()
                End Using

                For Each collabElement In albumData("collaborators").EnumerateArray()
                    Using cmd = db.CreateCommand("INSERT INTO autoresalbumes (idartista, idalbum, ft) VALUES (@idartista, @idalbum, @ft)")
                        cmd.Parameters.AddWithValue("@idartista", collabElement.GetInt32())
                        cmd.Parameters.AddWithValue("@idalbum", albumId)
                        cmd.Parameters.AddWithValue("@ft", True)
                        cmd.ExecuteNonQuery()
                    End Using
                Next
            End If

            ' Actualizar canciones del álbum si están presentes
            If albumData.ContainsKey("songs") Then
                Using cmd = db.CreateCommand("DELETE FROM cancionesalbumes WHERE idalbum = @id")
                    cmd.Parameters.AddWithValue("@id", albumId)
                    cmd.ExecuteNonQuery()
                End Using

                Dim trackNumber As Integer = 1
                For Each songElement In albumData("songs").EnumerateArray()
                    Using cmd = db.CreateCommand("INSERT INTO cancionesalbumes (idcancion, idalbum, tracknumber) VALUES (@idcancion, @idalbum, @tracknumber)")
                        cmd.Parameters.AddWithValue("@idcancion", songElement.GetInt32())
                        cmd.Parameters.AddWithValue("@idalbum", albumId)
                        cmd.Parameters.AddWithValue("@tracknumber", trackNumber)
                        cmd.ExecuteNonQuery()
                    End Using
                    trackNumber += 1
                Next
            End If

            jsonResponse = ConvertToJson(New Dictionary(Of String, String) From {{"message", "Álbum actualizado exitosamente"}})
            statusCode = HttpStatusCode.OK

        Catch ex As Exception
            jsonResponse = GenerateErrorResponse("500", "Error al actualizar el álbum: " & ex.Message)
            statusCode = HttpStatusCode.InternalServerError
        End Try
    End Sub

    '==========================================================================
    ' M�TODOS PARA MERCH
    '==========================================================================
    Sub uploadMerch(request As HttpListenerRequest, action As String, ByRef jsonResponse As String, ByRef statusCode As Integer)
        Try
            Dim body As String
            Using reader As New StreamReader(request.InputStream, request.ContentEncoding)
                body = reader.ReadToEnd()
            End Using

            Dim merchData = JsonSerializer.Deserialize(Of Dictionary(Of String, JsonElement))(body)

            ' Validar campos requeridos
            If Not merchData.ContainsKey("title") OrElse Not merchData.ContainsKey("price") OrElse
               Not merchData.ContainsKey("cover") Then
                jsonResponse = GenerateErrorResponse("400", "Faltan campos requeridos")
                statusCode = HttpStatusCode.BadRequest
                Return
            End If

            Dim title As String = merchData("title").GetString()
            Dim description As String = If(merchData.ContainsKey("description"), merchData("description").GetString(), "")
            Dim price As Decimal = merchData("price").GetDecimal()
            Dim cover As String = merchData("cover").GetString()

            ' Insertar merchandising
            Dim newMerchId As Integer
            Using cmd = db.CreateCommand("INSERT INTO merch (nombre, descripcion, precio, imagen) VALUES (@nombre, @descripcion, @precio, @imagen) RETURNING idmerch")
                cmd.Parameters.AddWithValue("@nombre", title)
                cmd.Parameters.AddWithValue("@descripcion", description)
                cmd.Parameters.AddWithValue("@precio", price)
                cmd.Parameters.AddWithValue("@imagen", cover)
                newMerchId = CInt(cmd.ExecuteScalar())
            End Using

            ' Insertar colaboradores/artistas
            If merchData.ContainsKey("collaborators") Then
                For Each collabElement In merchData("collaborators").EnumerateArray()
                    Dim artistId As Integer = collabElement.GetInt32()
                    Using cmd = db.CreateCommand("INSERT INTO merchartistas (idmerch, idartista) VALUES (@idmerch, @idartista)")
                        cmd.Parameters.AddWithValue("@idmerch", newMerchId)
                        cmd.Parameters.AddWithValue("@idartista", artistId)
                        cmd.ExecuteNonQuery()
                    End Using
                Next
            End If

            jsonResponse = ConvertToJson(New Dictionary(Of String, Object) From {{"merchId", newMerchId}, {"message", "Merchandising creado exitosamente"}})
            statusCode = HttpStatusCode.OK

        Catch ex As Exception
            jsonResponse = GenerateErrorResponse("500", "Error al crear el merchandising: " & ex.Message)
            statusCode = HttpStatusCode.InternalServerError
        End Try
    End Sub

    Sub searchMerch(request As HttpListenerRequest, action As String, ByRef jsonResponse As String, ByRef statusCode As Integer)
        Try
            Dim query As String = request.QueryString("q")
            If String.IsNullOrEmpty(query) Then
                jsonResponse = GenerateErrorResponse("400", "Parámetro de búsqueda 'q' requerido")
                statusCode = HttpStatusCode.BadRequest
                Return
            End If

            Dim results As New List(Of Dictionary(Of String, Object))

            Using cmd = db.CreateCommand("SELECT idmerch FROM merch WHERE LOWER(nombre) LIKE LOWER(@query)")
                cmd.Parameters.AddWithValue("@query", "%" & query & "%")
                Using reader = cmd.ExecuteReader()
                    While reader.Read()
                        results.Add(New Dictionary(Of String, Object) From {{"merchId", reader.GetInt32(0)}})
                    End While
                End Using
            End Using

            jsonResponse = ConvertToJson(results)
            statusCode = HttpStatusCode.OK

        Catch ex As Exception
            jsonResponse = GenerateErrorResponse("500", "Error al buscar merchandising: " & ex.Message)
            statusCode = HttpStatusCode.InternalServerError
        End Try
    End Sub

    Sub getMerch(request As HttpListenerRequest, action As String, ByRef jsonResponse As String, ByRef statusCode As Integer)
        Try
            If Not IsNumeric(action) Then
                jsonResponse = GenerateErrorResponse("400", "ID de merchandising inválido")
                statusCode = HttpStatusCode.BadRequest
                Return
            End If

            Dim schema As New Dictionary(Of String, Object) From {
                {"merchId", Nothing},
                {"title", Nothing},
                {"artistId", Nothing},
                {"collaborators", Nothing},
                {"releaseDate", Nothing},
                {"description", Nothing},
                {"price", Nothing},
                {"cover", Nothing}
            }

            ' Recuperar datos del merchandising
            Using cmd = db.CreateCommand("SELECT nombre, descripcion, precio, imagen FROM merch WHERE idmerch = @id")
                cmd.Parameters.AddWithValue("@id", Integer.Parse(action))
                Using reader = cmd.ExecuteReader()
                    If reader.HasRows Then
                        While reader.Read()
                            schema("merchId") = action
                            schema("title") = reader.GetString(0)
                            schema("description") = reader.GetString(1)
                            schema("price") = reader.GetDecimal(2).ToString()
                            schema("cover") = reader.GetString(3)
                        End While
                    Else
                        jsonResponse = ""
                        statusCode = HttpStatusCode.NotFound
                        Return
                    End If
                End Using
            End Using

            ' Recuperar artistas asociados
            Dim collaborators As New List(Of Integer)
            Using cmd = db.CreateCommand("SELECT idartista FROM merchartistas WHERE idmerch = @id")
                cmd.Parameters.AddWithValue("@id", Integer.Parse(action))
                Using reader = cmd.ExecuteReader()
                    Dim first As Boolean = True
                    While reader.Read()
                        Dim artistId As Integer = reader.GetInt32(0)
                        If first Then
                            schema("artistId") = artistId.ToString()
                            first = False
                        Else
                            collaborators.Add(artistId)
                        End If
                    End While
                End Using
            End Using
            schema("collaborators") = collaborators

            schema("releaseDate") = Nothing ' No hay campo de fecha en merch

            jsonResponse = ConvertToJson(schema)
            statusCode = HttpStatusCode.OK

        Catch ex As Exception
            jsonResponse = GenerateErrorResponse("500", "Error al obtener el merchandising: " & ex.Message)
            statusCode = HttpStatusCode.InternalServerError
        End Try
    End Sub

    Sub deleteMerch(request As HttpListenerRequest, action As String, ByRef jsonResponse As String, ByRef statusCode As Integer)
        Try
            If Not IsNumeric(action) Then
                jsonResponse = GenerateErrorResponse("400", "ID de merchandising inválido")
                statusCode = HttpStatusCode.BadRequest
                Return
            End If

            Dim merchId As Integer = Integer.Parse(action)

            ' Eliminar merchandising (las relaciones se eliminan en cascada)
            Using cmd = db.CreateCommand("DELETE FROM merch WHERE idmerch = @id")
                cmd.Parameters.AddWithValue("@id", merchId)
                Dim rowsAffected As Integer = cmd.ExecuteNonQuery()
                
                If rowsAffected = 0 Then
                    jsonResponse = GenerateErrorResponse("404", "Merchandising no encontrado")
                    statusCode = HttpStatusCode.NotFound
                Else
                    jsonResponse = ConvertToJson(New Dictionary(Of String, String) From {{"message", "Merchandising eliminado exitosamente"}})
                    statusCode = HttpStatusCode.OK
                End If
            End Using

        Catch ex As Exception
            jsonResponse = GenerateErrorResponse("500", "Error al eliminar el merchandising: " & ex.Message)
            statusCode = HttpStatusCode.InternalServerError
        End Try
    End Sub

    Sub updateMerch(request As HttpListenerRequest, action As String, ByRef jsonResponse As String, ByRef statusCode As Integer)
        Try
            If Not IsNumeric(action) Then
                jsonResponse = GenerateErrorResponse("400", "ID de merchandising inválido")
                statusCode = HttpStatusCode.BadRequest
                Return
            End If

            Dim merchId As Integer = Integer.Parse(action)

            Dim body As String
            Using reader As New StreamReader(request.InputStream, request.ContentEncoding)
                body = reader.ReadToEnd()
            End Using

            Dim merchData = JsonSerializer.Deserialize(Of Dictionary(Of String, JsonElement))(body)

            ' Construir UPDATE dinámico
            Dim updates As New List(Of String)
            Dim cmdText As String = "UPDATE merch SET "

            Using cmd = db.CreateCommand("")
                If merchData.ContainsKey("title") Then
                    updates.Add("nombre = @nombre")
                    cmd.Parameters.AddWithValue("@nombre", merchData("title").GetString())
                End If
                If merchData.ContainsKey("description") Then
                    updates.Add("descripcion = @descripcion")
                    cmd.Parameters.AddWithValue("@descripcion", merchData("description").GetString())
                End If
                If merchData.ContainsKey("price") Then
                    updates.Add("precio = @precio")
                    cmd.Parameters.AddWithValue("@precio", merchData("price").GetDecimal())
                End If
                If merchData.ContainsKey("cover") Then
                    updates.Add("imagen = @imagen")
                    cmd.Parameters.AddWithValue("@imagen", merchData("cover").GetString())
                End If

                If updates.Count > 0 Then
                    cmd.CommandText = cmdText & String.Join(", ", updates) & " WHERE idmerch = @id"
                    cmd.Parameters.AddWithValue("@id", merchId)
                    cmd.ExecuteNonQuery()
                End If
            End Using

            ' Actualizar artistas asociados si están presentes
            If merchData.ContainsKey("collaborators") Then
                Using cmd = db.CreateCommand("DELETE FROM merchartistas WHERE idmerch = @id")
                    cmd.Parameters.AddWithValue("@id", merchId)
                    cmd.ExecuteNonQuery()
                End Using

                For Each collabElement In merchData("collaborators").EnumerateArray()
                    Using cmd = db.CreateCommand("INSERT INTO merchartistas (idmerch, idartista) VALUES (@idmerch, @idartista)")
                        cmd.Parameters.AddWithValue("@idmerch", merchId)
                        cmd.Parameters.AddWithValue("@idartista", collabElement.GetInt32())
                        cmd.ExecuteNonQuery()
                    End Using
                Next
            End If

            jsonResponse = ConvertToJson(New Dictionary(Of String, String) From {{"message", "Merchandising actualizado exitosamente"}})
            statusCode = HttpStatusCode.OK

        Catch ex As Exception
            jsonResponse = GenerateErrorResponse("500", "Error al actualizar el merchandising: " & ex.Message)
            statusCode = HttpStatusCode.InternalServerError
        End Try
    End Sub

    '==========================================================================
    ' M�TODOS PARA ARTIST
    '==========================================================================
    Sub uploadArtist(request As HttpListenerRequest, action As String, ByRef jsonResponse As String, ByRef statusCode As Integer)
        Try
            Dim body As String
            Using reader As New StreamReader(request.InputStream, request.ContentEncoding)
                body = reader.ReadToEnd()
            End Using

            Dim artistData = JsonSerializer.Deserialize(Of Dictionary(Of String, JsonElement))(body)

            ' Validar campos requeridos
            If Not artistData.ContainsKey("artisticName") OrElse Not artistData.ContainsKey("artisticEmail") OrElse
               Not artistData.ContainsKey("userId") Then
                jsonResponse = GenerateErrorResponse("400", "Faltan campos requeridos")
                statusCode = HttpStatusCode.BadRequest
                Return
            End If

            Dim artisticName As String = artistData("artisticName").GetString()
            Dim biography As String = If(artistData.ContainsKey("artisticBiography"), artistData("artisticBiography").GetString(), "")
            Dim image As String = If(artistData.ContainsKey("artisticImage"), artistData("artisticImage").GetString(), "")
            Dim registrationDate As String = DateTime.Now.ToString("yyyy-MM-dd")

            ' Insertar artista
            Dim newArtistId As Integer
            Using cmd = db.CreateCommand("INSERT INTO artistas (nombre, imagen, bio, fechainicio) VALUES (@nombre, @imagen, @bio, @fecha) RETURNING idartista")
                cmd.Parameters.AddWithValue("@nombre", artisticName)
                cmd.Parameters.AddWithValue("@imagen", image)
                cmd.Parameters.AddWithValue("@bio", biography)
                cmd.Parameters.AddWithValue("@fecha", Date.Parse(registrationDate))
                newArtistId = CInt(cmd.ExecuteScalar())
            End Using

            ' Nota: No hay tabla para vincular userId con artistId en el schema SQL proporcionado
            ' Si fuera necesario, deberías crear una tabla adicional o agregar el campo userId a la tabla Artistas

            jsonResponse = ConvertToJson(New Dictionary(Of String, Object) From {{"artistId", newArtistId}, {"message", "Artista creado exitosamente"}})
            statusCode = HttpStatusCode.OK

        Catch ex As Exception
            jsonResponse = GenerateErrorResponse("500", "Error al crear el artista: " & ex.Message)
            statusCode = HttpStatusCode.InternalServerError
        End Try
    End Sub

    Sub searchArtist(request As HttpListenerRequest, action As String, ByRef jsonResponse As String, ByRef statusCode As Integer)
        Try
            Dim query As String = request.QueryString("q")
            If String.IsNullOrEmpty(query) Then
                jsonResponse = GenerateErrorResponse("400", "Parámetro de búsqueda 'q' requerido")
                statusCode = HttpStatusCode.BadRequest
                Return
            End If

            Dim results As New List(Of Dictionary(Of String, Object))

            Using cmd = db.CreateCommand("SELECT idartista FROM artistas WHERE LOWER(nombre) LIKE LOWER(@query)")
                cmd.Parameters.AddWithValue("@query", "%" & query & "%")
                Using reader = cmd.ExecuteReader()
                    While reader.Read()
                        results.Add(New Dictionary(Of String, Object) From {{"artistId", reader.GetInt32(0)}})
                    End While
                End Using
            End Using

            jsonResponse = ConvertToJson(results)
            statusCode = HttpStatusCode.OK

        Catch ex As Exception
            jsonResponse = GenerateErrorResponse("500", "Error al buscar artistas: " & ex.Message)
            statusCode = HttpStatusCode.InternalServerError
        End Try
    End Sub

    Sub getArtist(request As HttpListenerRequest, action As String, ByRef jsonResponse As String, ByRef statusCode As Integer)
        Try
            If Not IsNumeric(action) Then
                jsonResponse = GenerateErrorResponse("400", "ID de artista inválido")
                statusCode = HttpStatusCode.BadRequest
                Return
            End If

            Dim schema As New Dictionary(Of String, Object) From {
                {"artistId", Nothing},
                {"artisticName", Nothing},
                {"artisticBiography", Nothing},
                {"artisticEmail", Nothing},
                {"artisticImage", Nothing},
                {"socialMediaUrl", Nothing},
                {"registrationDate", Nothing},
                {"userId", Nothing}
            }

            ' Recuperar datos del artista
            Using cmd = db.CreateCommand("SELECT nombre, imagen, bio, fechainicio FROM artistas WHERE idartista = @id")
                cmd.Parameters.AddWithValue("@id", Integer.Parse(action))
                Using reader = cmd.ExecuteReader()
                    If reader.HasRows Then
                        While reader.Read()
                            schema("artistId") = action
                            schema("artisticName") = reader.GetString(0)
                            schema("artisticImage") = reader.GetString(1)
                            schema("artisticBiography") = reader.GetString(2)
                            schema("registrationDate") = reader.GetDateTime(3).ToString("yyyy-MM-dd")
                        End While
                    Else
                        jsonResponse = ""
                        statusCode = HttpStatusCode.NotFound
                        Return
                    End If
                End Using
            End Using

            ' Campos no disponibles en la tabla actual
            schema("artisticEmail") = Nothing
            schema("socialMediaUrl") = Nothing
            schema("userId") = Nothing

            jsonResponse = ConvertToJson(schema)
            statusCode = HttpStatusCode.OK

        Catch ex As Exception
            jsonResponse = GenerateErrorResponse("500", "Error al obtener el artista: " & ex.Message)
            statusCode = HttpStatusCode.InternalServerError
        End Try
    End Sub

    Sub deleteArtist(request As HttpListenerRequest, action As String, ByRef jsonResponse As String, ByRef statusCode As Integer)
        Try
            If Not IsNumeric(action) Then
                jsonResponse = GenerateErrorResponse("400", "ID de artista inválido")
                statusCode = HttpStatusCode.BadRequest
                Return
            End If

            Dim artistId As Integer = Integer.Parse(action)

            ' Eliminar artista (las relaciones se eliminan en cascada)
            Using cmd = db.CreateCommand("DELETE FROM artistas WHERE idartista = @id")
                cmd.Parameters.AddWithValue("@id", artistId)
                Dim rowsAffected As Integer = cmd.ExecuteNonQuery()
                
                If rowsAffected = 0 Then
                    jsonResponse = GenerateErrorResponse("404", "Artista no encontrado")
                    statusCode = HttpStatusCode.NotFound
                Else
                    jsonResponse = ConvertToJson(New Dictionary(Of String, String) From {{"message", "Artista eliminado exitosamente"}})
                    statusCode = HttpStatusCode.OK
                End If
            End Using

        Catch ex As Exception
            jsonResponse = GenerateErrorResponse("500", "Error al eliminar el artista: " & ex.Message)
            statusCode = HttpStatusCode.InternalServerError
        End Try
    End Sub

    Sub updateArtist(request As HttpListenerRequest, action As String, ByRef jsonResponse As String, ByRef statusCode As Integer)
        Try
            If Not IsNumeric(action) Then
                jsonResponse = GenerateErrorResponse("400", "ID de artista inválido")
                statusCode = HttpStatusCode.BadRequest
                Return
            End If

            Dim artistId As Integer = Integer.Parse(action)

            Dim body As String
            Using reader As New StreamReader(request.InputStream, request.ContentEncoding)
                body = reader.ReadToEnd()
            End Using

            Dim artistData = JsonSerializer.Deserialize(Of Dictionary(Of String, JsonElement))(body)

            ' Construir UPDATE dinámico
            Dim updates As New List(Of String)
            Dim cmdText As String = "UPDATE artistas SET "

            Using cmd = db.CreateCommand("")
                If artistData.ContainsKey("artisticName") Then
                    updates.Add("nombre = @nombre")
                    cmd.Parameters.AddWithValue("@nombre", artistData("artisticName").GetString())
                End If
                If artistData.ContainsKey("artisticImage") Then
                    updates.Add("imagen = @imagen")
                    cmd.Parameters.AddWithValue("@imagen", artistData("artisticImage").GetString())
                End If
                If artistData.ContainsKey("artisticBiography") Then
                    updates.Add("bio = @bio")
                    cmd.Parameters.AddWithValue("@bio", artistData("artisticBiography").GetString())
                End If

                If updates.Count > 0 Then
                    cmd.CommandText = cmdText & String.Join(", ", updates) & " WHERE idartista = @id"
                    cmd.Parameters.AddWithValue("@id", artistId)
                    cmd.ExecuteNonQuery()
                End If
            End Using

            jsonResponse = ConvertToJson(New Dictionary(Of String, String) From {{"message", "Artista actualizado exitosamente"}})
            statusCode = HttpStatusCode.OK

        Catch ex As Exception
            jsonResponse = GenerateErrorResponse("500", "Error al actualizar el artista: " & ex.Message)
            statusCode = HttpStatusCode.InternalServerError
        End Try
    End Sub

End Module
