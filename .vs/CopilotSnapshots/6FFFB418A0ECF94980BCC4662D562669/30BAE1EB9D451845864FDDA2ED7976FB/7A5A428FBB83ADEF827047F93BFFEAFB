Imports System
Imports System.Net
Imports System.IO
Imports System.Text
Imports System.Threading.Tasks

Module Program
    Sub Main(args As String())
        '==========================================================================
        ' Microservicio TEMAS y AUTORES proyecto OverSounds - GPS 2025-2026
        ' Creado por: José Manuel de Torres Dominguez
        '==========================================================================
        ' PARÁMETROS DE CONFIGURACIÓN
        Dim host_ip As String = "localhost"
        Dim host_port As Integer = 8080
        Dim postgres_conn As String = ""
        '==========================================================================

        ' Iniciar el servidor de manera asíncrona
        StartServerAsync(host_ip, host_port).GetAwaiter().GetResult()
    End Sub

    Async Function StartServerAsync(host_ip As String, host_port As Integer) As Task
        ' Crear el servidor HTTP
        Dim listener As New HttpListener()
        ' Configurar el prefijo (URL base) donde escuchar
        listener.Prefixes.Add("http://" + host_ip + ":" + host_port.ToString() + "/")

        Try
            ' Iniciar el servidor
            listener.Start()
            Console.WriteLine("Servidor HTTP iniciado en http://" + host_ip + ":" + host_port.ToString())
            Console.WriteLine("Servidor configurado para manejar peticiones asíncronas")
            Console.WriteLine("Presiona Ctrl+C para detener el servidor")
            Console.WriteLine()

            ' Bucle principal para manejar peticiones
            While True
                ' Esperar por una petición de manera asíncrona
                Dim context As HttpListenerContext = Await listener.GetContextAsync()

                ' Manejar cada petición en una tarea separada (sin esperar a que termine)
                Dim fireAndForget = Task.Run(Async Function()
                                                Await HandleRequestAsync(context.Request, context.Response)
                                            End Function)
            End While

        Catch ex As Exception
            Console.WriteLine($"Error: {ex.Message}")
        Finally
            ' Detener el servidor
            listener.Stop()
            Console.WriteLine("Servidor detenido")
        End Try
    End Function

    Async Function HandleRequestAsync(request As HttpListenerRequest, response As HttpListenerResponse) As Task
        Dim responseString As String = ""
        Dim statusCode As Integer = 200

        Try
            ' Mostrar información de la petición
            Console.WriteLine($"[{DateTime.Now:HH:mm:ss}] Petición recibida: {request.HttpMethod} {request.Url.AbsolutePath}")

            ' Detectar la ruta personalizada
            Select Case request.Url.AbsolutePath
                Case "/foo/bar"
                    ' Manejar la ruta foo/bar
                    responseString = CreateJsonResponse("success", "Ruta foo/bar detectada correctamente")
                    response.ContentType = "application/json"
                    statusCode = 200

                Case "/"
                    ' Ruta raíz
                    responseString = CreateJsonResponse("info", "Servidor HTTP funcionando. Prueba /foo/bar")
                    response.ContentType = "application/json"
                    statusCode = 200

                Case Else
                    ' Ruta no encontrada
                    responseString = CreateJsonResponse("error", "Ruta no encontrada")
                    response.ContentType = "application/json"
                    statusCode = 404
            End Select

            ' Configurar la respuesta
            response.StatusCode = statusCode
            Dim buffer As Byte() = Encoding.UTF8.GetBytes(responseString)
            response.ContentLength64 = buffer.Length

            ' Enviar la respuesta de manera asíncrona
            Dim output As Stream = response.OutputStream
            Await output.WriteAsync(buffer, 0, buffer.Length)
            output.Close()

            Console.WriteLine($"[{DateTime.Now:HH:mm:ss}] Respuesta enviada: {statusCode} - {responseString}")
            Console.WriteLine()

        Catch ex As Exception
            Console.WriteLine($"[{DateTime.Now:HH:mm:ss}] Error procesando petición: {ex.Message}")
            Try
                response.StatusCode = 500
                response.Close()
            Catch
                ' Ignorar errores al cerrar la respuesta
            End Try
        End Try
    End Function

    Function CreateJsonResponse(status As String, message As String) As String
        Return $"{{""status"": ""{status}"", ""message"": ""{message}""}}"
    End Function
End Module
