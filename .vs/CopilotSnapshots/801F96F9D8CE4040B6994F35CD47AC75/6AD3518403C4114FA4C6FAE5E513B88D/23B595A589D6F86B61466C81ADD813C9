Imports System
Imports System.Net
Imports System.IO
Imports System.Text
Imports System.Threading.Tasks
Imports System.Text.Json
Imports Npgsql

Module Program

    '==========================================================================
    ' Microservicio TEMAS y AUTORES proyecto OverSounds - GPS 2025-2026
    ' Creado por: José Manuel de Torres Dominguez
    '==========================================================================
    ' PARÁMETROS DE CONFIGURACIÓN
    Dim host_ip As String = "localhost"
    Dim host_port As Integer = 8080
    Dim connectionString = "Host=pgnweb.ddns.net;Username=tya_admin;Password=12345;Database=tya"
    Dim db As NpgsqlDataSource = Nothing
    '==========================================================================

    Sub Main(args As String())
        ' Conectarse a la base de datos PostgreSQL
        Try
            db = NpgsqlDataSource.Create(connectionString)
            Console.WriteLine("Conexión a la base de datos PostgreSQL establecida correctamente.")
        Catch ex As Exception
            Console.WriteLine("Error al conectar a la base de datos PostgreSQL: " & ex.Message)
            Return
        End Try

        ' Iniciar el servidor de manera asíncrona
        StartServerAsync(host_ip, host_port).GetAwaiter().GetResult()
    End Sub

    Async Function StartServerAsync(host_ip As String, host_port As Integer) As Task
        ' Crear el servidor HTTP
        Dim listener As New HttpListener()
        ' Configurar el prefijo (URL base) donde escuchar
        listener.Prefixes.Add("http://" + host_ip + ":" + host_port.ToString() + "/")

        Try
            ' Iniciar el servidor
            listener.Start()
            Console.WriteLine("Servidor HTTP iniciado en http://" + host_ip + ":" + host_port.ToString())
            Console.WriteLine("Presiona Ctrl+C para detener el servidor")
            Console.WriteLine()

            ' Bucle principal para manejar peticiones
            While True
                ' Esperar por una petición de manera asíncrona
                Dim context As HttpListenerContext = Await listener.GetContextAsync()

                ' Manejar cada petición en una tarea separada (sin esperar a que termine)
                Dim fireAndForget = Task.Run(Async Function()
                                                 Await HandleRequestAsync(context.Request, context.Response)
                                             End Function)
            End While

        Catch ex As Exception
            Console.WriteLine($"Error: {ex.Message}")
        Finally
            ' Detener el servidor
            listener.Stop()
            Console.WriteLine("Servidor detenido")
        End Try
    End Function

    Async Function HandleRequestAsync(request As HttpListenerRequest, response As HttpListenerResponse) As Task
        Dim jsonResponse As String = GenerateErrorResponse("501", "No implementado")
        Dim contentType = "application/json"
        Dim statusCode As Integer = HttpStatusCode.OK
        Dim URLpath As String() = request.Url.AbsolutePath.Split("/"c) ' Ejemplo: /song/123

        Try
            ' Mostrar información de la petición
            Console.WriteLine($"[{DateTime.Now:HH:mm:ss}] Petición recibida: {request.HttpMethod} {request.Url.AbsolutePath}")

            ' Obtener segmentos de la URL de manera segura
            Dim resource As String = If(URLpath.Length > 1, URLpath(1), "")
            Dim action As String = If(URLpath.Length > 2, URLpath(2), "")

            ' Detectar la ruta personalizada
            If resource = "song" Then

                If action = "upload" AndAlso request.HttpMethod = "POST" Then
                    uploadSong(request, action, jsonResponse, statusCode)

                ElseIf action = "search" AndAlso request.HttpMethod = "GET" Then
                    searchSong(request, action, jsonResponse, statusCode)

                ElseIf IsNumeric(action) AndAlso request.HttpMethod = "GET" Then
                    getSong(request, action, jsonResponse, statusCode)

                ElseIf IsNumeric(action) AndAlso request.HttpMethod = "DELETE" Then
                    deleteSong(request, action, jsonResponse, statusCode)

                ElseIf IsNumeric(action) AndAlso request.HttpMethod = "PATCH" Then
                    updateSong(request, action, jsonResponse, statusCode)

                Else
                    ' Ruta no encontrada
                    jsonResponse = GenerateErrorResponse("404", "Recurso no encontrado")
                    statusCode = HttpStatusCode.NotFound
                End If


            ElseIf resource = "album" Then

                If action = "upload" AndAlso request.HttpMethod = "POST" Then
                    uploadAlbum(request, action, jsonResponse, statusCode)

                ElseIf action = "search" AndAlso request.HttpMethod = "GET" Then
                    searchAlbum(request, action, jsonResponse, statusCode)

                ElseIf IsNumeric(action) AndAlso request.HttpMethod = "GET" Then
                    getAlbum(request, action, jsonResponse, statusCode)

                ElseIf IsNumeric(action) AndAlso request.HttpMethod = "DELETE" Then
                    deleteAlbum(request, action, jsonResponse, statusCode)

                ElseIf IsNumeric(action) AndAlso request.HttpMethod = "PATCH" Then
                    updateAlbum(request, action, jsonResponse, statusCode)

                Else
                    ' Ruta no encontrada
                    jsonResponse = GenerateErrorResponse("404", "Recurso no encontrado")
                    statusCode = HttpStatusCode.NotFound
                End If


            ElseIf resource = "merch" Then

                If action = "upload" AndAlso request.HttpMethod = "POST" Then
                    uploadMerch(request, action, jsonResponse, statusCode)

                ElseIf action = "search" AndAlso request.HttpMethod = "GET" Then
                    searchMerch(request, action, jsonResponse, statusCode)

                ElseIf IsNumeric(action) AndAlso request.HttpMethod = "GET" Then
                    getMerch(request, action, jsonResponse, statusCode)

                ElseIf IsNumeric(action) AndAlso request.HttpMethod = "DELETE" Then
                    deleteMerch(request, action, jsonResponse, statusCode)

                ElseIf IsNumeric(action) AndAlso request.HttpMethod = "PATCH" Then
                    updateMerch(request, action, jsonResponse, statusCode)

                Else
                    ' Ruta no encontrada
                    jsonResponse = GenerateErrorResponse("404", "Recurso no encontrado")
                    statusCode = HttpStatusCode.NotFound
                End If


            ElseIf resource = "artist" Then

                If action = "upload" AndAlso request.HttpMethod = "POST" Then
                    uploadArtist(request, action, jsonResponse, statusCode)

                ElseIf action = "search" AndAlso request.HttpMethod = "GET" Then
                    searchArtist(request, action, jsonResponse, statusCode)

                ElseIf IsNumeric(action) AndAlso request.HttpMethod = "GET" Then
                    getArtist(request, action, jsonResponse, statusCode)

                ElseIf IsNumeric(action) AndAlso request.HttpMethod = "DELETE" Then
                    deleteArtist(request, action, jsonResponse, statusCode)

                ElseIf IsNumeric(action) AndAlso request.HttpMethod = "PATCH" Then
                    updateArtist(request, action, jsonResponse, statusCode)

                Else
                    ' Ruta no encontrada
                    jsonResponse = GenerateErrorResponse("404", "Recurso no encontrado")
                    statusCode = HttpStatusCode.NotFound
                End If


            ElseIf request.Url.AbsolutePath = "/" Then
                ' Ruta raíz
                jsonResponse = ConvertToJson("Microservicio TEMAS y AUTORES proyecto OverSounds - GPS 2025-2026\nCreado por: José Manuel de Torres Dominguez")
                statusCode = HttpStatusCode.OK


            Else
                ' Ruta no encontrada
                jsonResponse = GenerateErrorResponse("404", "Recurso no encontrado")
                statusCode = HttpStatusCode.NotFound
            End If


            ' Configurar la respuesta
            response.StatusCode = statusCode
            response.ContentType = contentType
            Dim buffer As Byte() = Encoding.UTF8.GetBytes(jsonResponse)
            response.ContentLength64 = buffer.Length

            ' Enviar la respuesta de manera asíncrona
            Dim output As Stream = response.OutputStream
            Await output.WriteAsync(buffer, 0, buffer.Length)
            output.Close()

            Console.WriteLine($"[{DateTime.Now:HH:mm:ss}] Respuesta enviada: {statusCode} - {jsonResponse.Replace(Environment.NewLine, "")}")
            Console.WriteLine()

        Catch ex As Exception
            Console.WriteLine($"[{DateTime.Now:HH:mm:ss}] Error procesando petición: {ex.Message}")
            Console.WriteLine(ex.ToString)

            Try
                response.StatusCode = 500
                response.Close()
            Catch
                ' Ignorar errores al cerrar la respuesta
            End Try
        End Try
    End Function

    ' Función helper para convertir lista de Strings a JSON
    Function ConvertToJson(obj As Object) As String
        Dim options As New JsonSerializerOptions With {.WriteIndented = True}
        Return JsonSerializer.Serialize(obj, options)
    End Function

    ' Funcion helper para generar una respuesta error JSON
    Function GenerateErrorResponse(code As String, message As String) As String
        Dim errorObj As New Dictionary(Of String, String) From {{"code", code}, {"message", message}}
        Return ConvertToJson(errorObj)
    End Function


    '==========================================================================
    ' LÓGICA DE NEGOCIO
    '==========================================================================


    '==========================================================================
    ' MÉTODOS PARA SONG
    '==========================================================================
    Sub uploadSong(request As HttpListenerRequest, action As String, ByRef jsonResponse As String, ByRef statusCode As Integer)
        ' TODO: Implementar lógica
    End Sub

    Sub searchSong(request As HttpListenerRequest, action As String, ByRef jsonResponse As String, ByRef statusCode As Integer)
        ' TODO: Implementar lógica
    End Sub

    Sub getSong(request As HttpListenerRequest, action As String, ByRef jsonResponse As String, ByRef statusCode As Integer)
        Dim list As New List(Of Dictionary(Of String, String))

        ' Recuperar todas las filas
        Using cmd = db.CreateCommand("SELECT some_field FROM data")
            Using reader = cmd.ExecuteReader()
                While reader.Read()
                    ' Get column name and value
                    Dim row As New Dictionary(Of String, String)
                    row("some_field") = reader.GetString(0)

                End While
            End Using
        End Using

        jsonResponse = ConvertToJson(list)
        statusCode = HttpStatusCode.OK
    End Sub

    Sub deleteSong(request As HttpListenerRequest, action As String, ByRef jsonResponse As String, ByRef statusCode As Integer)
        ' TODO: Implementar lógica
    End Sub

    Sub updateSong(request As HttpListenerRequest, action As String, ByRef jsonResponse As String, ByRef statusCode As Integer)
        ' TODO: Implementar lógica
    End Sub

    '==========================================================================
    ' MÉTODOS PARA ALBUM
    '==========================================================================
    Sub uploadAlbum(request As HttpListenerRequest, action As String, ByRef jsonResponse As String, ByRef statusCode As Integer)
        ' TODO: Implementar lógica
    End Sub

    Sub searchAlbum(request As HttpListenerRequest, action As String, ByRef jsonResponse As String, ByRef statusCode As Integer)
        ' TODO: Implementar lógica
    End Sub

    Sub getAlbum(request As HttpListenerRequest, action As String, ByRef jsonResponse As String, ByRef statusCode As Integer)
        ' TODO: Implementar lógica
    End Sub

    Sub deleteAlbum(request As HttpListenerRequest, action As String, ByRef jsonResponse As String, ByRef statusCode As Integer)
        ' TODO: Implementar lógica
    End Sub

    Sub updateAlbum(request As HttpListenerRequest, action As String, ByRef jsonResponse As String, ByRef statusCode As Integer)
        ' TODO: Implementar lógica
    End Sub

    '==========================================================================
    ' MÉTODOS PARA MERCH
    '==========================================================================
    Sub uploadMerch(request As HttpListenerRequest, action As String, ByRef jsonResponse As String, ByRef statusCode As Integer)
        ' TODO: Implementar lógica
    End Sub

    Sub searchMerch(request As HttpListenerRequest, action As String, ByRef jsonResponse As String, ByRef statusCode As Integer)
        ' TODO: Implementar lógica
    End Sub

    Sub getMerch(request As HttpListenerRequest, action As String, ByRef jsonResponse As String, ByRef statusCode As Integer)
        ' TODO: Implementar lógica
    End Sub

    Sub deleteMerch(request As HttpListenerRequest, action As String, ByRef jsonResponse As String, ByRef statusCode As Integer)
        ' TODO: Implementar lógica
    End Sub

    Sub updateMerch(request As HttpListenerRequest, action As String, ByRef jsonResponse As String, ByRef statusCode As Integer)
        ' TODO: Implementar lógica
    End Sub

    '==========================================================================
    ' MÉTODOS PARA ARTIST
    '==========================================================================
    Sub uploadArtist(request As HttpListenerRequest, action As String, ByRef jsonResponse As String, ByRef statusCode As Integer)
        ' TODO: Implementar lógica
    End Sub

    Sub searchArtist(request As HttpListenerRequest, action As String, ByRef jsonResponse As String, ByRef statusCode As Integer)
        ' TODO: Implementar lógica
    End Sub

    Sub getArtist(request As HttpListenerRequest, action As String, ByRef jsonResponse As String, ByRef statusCode As Integer)
        ' TODO: Implementar lógica
    End Sub

    Sub deleteArtist(request As HttpListenerRequest, action As String, ByRef jsonResponse As String, ByRef statusCode As Integer)
        ' TODO: Implementar lógica
    End Sub

    Sub updateArtist(request As HttpListenerRequest, action As String, ByRef jsonResponse As String, ByRef statusCode As Integer)
        ' TODO: Implementar lógica
    End Sub

End Module
